@page "/task/{TaskName}"
@using DopamineXP.Models
@inject Services.TrackerBrain Brain
@inject NavigationManager NavManager

<div class="tracker-container" style="@($"--theme-color: {activeTask?.HexColor ?? "#ffffff"};")">
    
    @if (isPageNull())
    {
        <div class="main-scene">
            <h1 style="color: white; text-align: center; margin-top: 50px;">Task Not Found!</h1>
        </div>
    }
    else
    {
        <div class="main-scene">
            <div class="task-header">
                @if (!_isEditing)
                {
                    <h1 class="task-title">@activeTask.Name.ToUpper()</h1>
                    <div class="edit-btn" @onclick="ToggleEdit">EDIT SETTINGS</div>
                    if (activeTask.Habit.IsHardcore)
                    {
                        <div class="hardcore-mode-text">HARDCORE MODE IS ON</div>
                    }
                }
                else
                {
                    <div class="edit-mode-container">
                        <input type="text" class="xp-input" style="width: 250px; text-align: left;" @bind="_editName" />
                        <input type="color" class="color-input" style="width: 60px; height: 45px; cursor: pointer;" @bind="_editColor" />
                        
                        <div class="save-btn" @onclick="SaveChanges">SAVE</div>
                        <div class="cancel-btn" @onclick="ToggleEdit">CANCEL</div>
                    </div>
                }
            </div>
            
            <div class="task-content">
                <div class="level-container">
                    <div class="level-xp-text">
                        <span class="level-text">Level @activeTask.Stats.Level</span>
                        <span class="xp-text">@(activeTask.FormatNumber(activeTask.Stats.XP))/@(activeTask.FormatNumber(activeTask.Stats.Threshold))XP</span>
                    </div>
                    
                    <div class="progress-track-bar">
                        <div class="progress-fill-bar" style="width: @(activeTask.Stats.XP < activeTask.Stats.Threshold ? (activeTask.Stats.XP / activeTask.Stats.Threshold * 100) : 100)%"></div>
                    </div>
                    
                    <div class="level-input-buttons">
                        <input type="number" class="xp-input" placeholder="Minutes" min="0" @bind="_minutesSpent"/>
                        <div class="append-xp-btn" @onclick="AppendXp">APPEND</div>
                        <div class="level-up-btn @CanLevelUp()" @onclick="LevelUp">LEVEL UP!</div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(activeTask.Habit.DailyStreakMessage))
                    {
                        string colorClass = "streak-msg-progress"; 

                        if (activeTask.Habit.LastStreakEarnedDateTime == DateTime.Today)
                        {
                            colorClass = "streak-msg-hit";
                        }
                        else if (activeTask.Habit.DailyStreakMessage.Contains("FREEZE"))
                        {
                            colorClass = "streak-msg-freeze";
                        }

                        <div class="streak-msg-base @colorClass">
                            @activeTask.Habit.DailyStreakMessage
                        </div>
                    }
                </div>
                
                <div class="points-streak">
                    <span class="points-text">@activeTask.Shop.Points @(!isPageNull() ? activeTask.Name.Substring(0, 1).ToUpper() : "?")P</span>
                    <span class="streak-text">Streak: @activeTask.Habit.Streak days</span>
                </div>
                
            </div>
            <div class="level-text" style="font-weight: 600; font-size: 36px; text-align: center; margin-top: 20px">SHOP</div>
            <div class="shop-field">
                <div class="shop-style xp-boost-field"
                     style="@(activeTask.Shop.IsMultiplierBuffActive ? "box-shadow: 0 8px 25px rgba(0, 255, 102, 0.2); border-color: rgba(0, 255, 102, 0.5);" : "")">
     
                    <div class="shop-item-title">XP Buff</div>
                    <div class="shop-item-desc">
                        @(activeTask.Shop.Multiplier)x XP for 24 Hours
                    </div>
    
                    <button class="buy-btn xp-buy"
                            disabled="@(activeTask.Shop.IsMultiplierBuffActive || activeTask.Shop.CanBuyMultiplier)"
                            @onclick="BuyMultiplier">
                        @(activeTask.Shop.IsMultiplierBuffActive ? "ACTIVE" : $"{activeTask.Shop.MultiplierPrice} {activeTask.Name.Substring(0, 1)}P")
                    </button>
                </div>

                <div class="shop-style streak-shield-field"
                     style="@(activeTask.Shop.HasFreeze ? "box-shadow: 0 8px 25px rgba(0, 157, 255, 0.2); border-color: rgba(0, 157, 255, 0.5);" : "" )">
                    <div class="shop-item-title">Streak Freeze</div>
                    <div class="shop-item-desc">Protects streak if you miss a day</div>
                    <div class="freeze-streak-amount">@activeTask.Shop.StreakFreezeAmount/5</div>
                    @if (!activeTask.Shop.HasFreezeInInventory)
                    {
                        <button class="buy-btn shield-buy"
                                disabled="@(activeTask.Shop.HasFreeze || activeTask.Shop.CanBuyFreeze)"
                                @onclick="BuyStreakFreeze">
                            @(activeTask.Shop.HasFreeze ? "ACTIVE" : !isPageNull() ? activeTask.Name.Substring(0, 1).ToUpper() + "P" : "?P")
                        </button>
                    }
                    else
                    {
                        <button class="buy-btn shield-buy"
                                disabled="@activeTask.Shop.HasFreeze"
                                @onclick="UseStreakFreeze"> @(activeTask.Shop.HasFreeze ? "ACTIVE" : "FREEZE!")</button>
                    }
                </div>
            </div>
            <div class="prestige-container">
                @if (!activeTask.CanPrestige)
                {
                    <div class="prestige-explanation-text" style="color: white;">REACH LEVEL 15 IN ORDER TO UNLOCK PRESTIGE</div>
                }
                else
                {
                    <div class="prestige-btn" @onclick="Prestige">PRESTIGE AND GET @activeTask.CoresForPrestige @activeTask.Name.ToUpper() @(activeTask.CoresForPrestige == 1 ? "CORE" : "CORES")</div>
                }
            </div>
            
            @if (activeTask.Stats.HasPrestiged)
            {
                <a href=@($"/task/cores/{System.Net.WebUtility.UrlEncode(activeTask.Name)}") class="to-cores-page-btn">GO TO THE CORES LABORATORY</a>
            }
            
            <div class="delete-container">
                <div class="delete-btn" @onclick="ShowDeleteConfirmation">DELETE TASK</div>
            </div>
            
            @if (_showDeleteWarning)
            {
                <div class="modal-overlay">
                    <div class="modal-box">
                        <div class="modal-title">SYSTEM PURGE</div>
                        <div class="modal-text">
                            Are you absolutely sure you want to delete <strong>@activeTask?.Name</strong>? 
                            <br><br>
                            All accumulated Shards, Cores, and historical XP will be permanently erased. This action cannot be undone.
                        </div>
            
                        <div class="modal-actions">
                            <button class="modal-btn cancel-btn" @onclick="CancelDelete">ABORT</button>
                            <button class="modal-btn confirm-btn" @onclick="ConfirmDelete">ERASE DATA</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public string TaskName { get; set; } = "";

    private DopamineTask? activeTask;
    private double? _minutesSpent;

    protected override void OnParametersSet()
    {
        string decodedName = System.Net.WebUtility.UrlDecode(TaskName);
        activeTask = Brain.CustomTasks.FirstOrDefault(t => t.Name.Equals(decodedName, StringComparison.OrdinalIgnoreCase));
        
        if (activeTask != null)
        {
            activeTask.CheckDailyReset();
            activeTask.TryGetFreeFreezeStreak();
            activeTask.EvaluateStreak();

            if (_isEditing)
                _isEditing = !_isEditing;

            _minutesSpent = null;
        }
    }

    private void AppendXp()
    {
        if (_minutesSpent == null || activeTask == null) return;

        activeTask.LogMinutes(_minutesSpent.Value);
        _minutesSpent = null;

        activeTask.EvaluateStreak();
        
        Brain.OnChange?.Invoke(); 
        Brain.SaveToFile();
    }

    private string CanLevelUp()
    {
        if (activeTask != null && activeTask.Stats.XP >= activeTask.Stats.Threshold)
            return "is-ready";
        return "";
    }

    private void LevelUp()
    {
        if (activeTask == null || activeTask.Stats.XP < activeTask.Stats.Threshold) return;
        
        activeTask.LevelUp();
        
        Brain.OnChange?.Invoke();
        Brain.SaveToFile();
    }
    
    private bool _showDeleteWarning = false;

    private void ShowDeleteConfirmation()
    {
        _showDeleteWarning = true;
    }

    private void CancelDelete()
    {
        _showDeleteWarning = false;
    }
    
    private void ConfirmDelete()
    {
        if (activeTask != null)
        {
            Brain.CustomTasks.Remove(activeTask);
            
            Brain.OnChange?.Invoke(); 
            Brain.SaveToFile();
            
            NavManager.NavigateTo("/"); 
        }
    }
    
    private bool _isEditing = false;
    private string _editName = "";
    private string _editColor = "";

    private void ToggleEdit()
    {
        if (activeTask != null)
        {
            _editName = activeTask.Name;
            _editColor = activeTask.HexColor;
            _isEditing = !_isEditing;
        }
    }

    private void SaveChanges()
    {
        if (activeTask != null && !string.IsNullOrWhiteSpace(_editName))
        {
            bool nameChanged = activeTask.Name != _editName;
            
            activeTask.Name = _editName;
            activeTask.HexColor = _editColor;
            _isEditing = false; 
            
            Brain.OnChange?.Invoke(); 
            Brain.SaveToFile();

            if (nameChanged)
            {
                NavManager.NavigateTo($"/task/{System.Net.WebUtility.UrlEncode(activeTask.Name)}");
            }
        }
    }

    private void BuyMultiplier()
    {
        if (activeTask.Shop.DidBuyMultiplier()) 
        {
            Brain.OnChange?.Invoke();
            Brain.SaveToFile();
        }
    }

    private void BuyStreakFreeze()
    {
        if (activeTask.Shop.DidBuyStreakFreeze())
        {
            activeTask.Habit.DailyStreakMessage = $"STREAK SAVED BY FREEZE! {activeTask.Habit.Streak} DAYS!";
            Brain.OnChange?.Invoke();
            Brain.SaveToFile();
        }
    }

    private void UseStreakFreeze()
    {
        activeTask.Shop.TryUseStreakFreeze();
    }

    private void Prestige()
    {
        activeTask?.ApplyPrestige();
        
        Brain.SaveToFile();
        
        NavManager.NavigateTo($"/task/cores/{System.Net.WebUtility.UrlEncode(activeTask.Name)}");
    }

    private bool isPageNull()
    {
        return string.IsNullOrEmpty(activeTask?.Name);
    }

    
}

